name: "Process Confirmed Paper"

on:
  issue_comment:
    types: [created]

jobs:
  process:
    # Only run on paper submissions awaiting confirmation, by the issue author
    if: |
      contains(github.event.issue.labels.*.name, 'awaiting-confirmation') &&
      github.event.comment.user.id == github.event.issue.user.id
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for confirmation
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim();
            const upperComment = comment.toUpperCase();
            
            // Check if this is a confirmation
            const isConfirm = upperComment.startsWith('CONFIRM');
            
            // Parse any corrections
            let corrections = {};
            
            const titleMatch = comment.match(/TITLE:\s*(.+?)(?:\n|$)/i);
            if (titleMatch) corrections.title = titleMatch[1].trim();
            
            const authorsMatch = comment.match(/AUTHORS:\s*(.+?)(?:\n|$)/i);
            if (authorsMatch) corrections.authors = authorsMatch[1].trim();
            
            const abstractMatch = comment.match(/ABSTRACT:\s*([\s\S]+?)(?:\n(?:TITLE|AUTHORS|CONFIRM):|$)/i);
            if (abstractMatch) corrections.abstract = abstractMatch[1].trim();
            
            const hasCorrections = Object.keys(corrections).length > 0;
            
            if (!isConfirm && !hasCorrections) {
              console.log('Not a confirmation or correction, skipping');
              core.setOutput('should_process', 'false');
              return;
            }
            
            core.setOutput('should_process', 'true');
            core.setOutput('corrections', JSON.stringify(corrections));
            console.log('Processing with corrections:', corrections);
      
      - name: Checkout repository
        if: steps.check.outputs.should_process == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        if: steps.check.outputs.should_process == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.check.outputs.should_process == 'true'
        run: |
          pip install pypdf reportlab pyyaml
      
      - name: Parse issue for PDF and category
        if: steps.check.outputs.should_process == 'true'
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            const categoryMatch = body.match(/### Category\s*\n\s*(\S+)/);
            const category = categoryMatch ? categoryMatch[1] : 'other';
            
            const pdfMatch = body.match(/https:\/\/[^\s\)]+\.pdf/i) || 
                            body.match(/https:\/\/github\.com\/user-attachments\/[^\s\)]+/);
            const pdfUrl = pdfMatch ? pdfMatch[0] : null;
            
            core.setOutput('category', category);
            core.setOutput('pdf_url', pdfUrl);
      
      - name: Download PDF
        if: steps.check.outputs.should_process == 'true'
        run: |
          mkdir -p temp
          curl -L -o temp/paper.pdf "${{ steps.parse.outputs.pdf_url }}"
      
      - name: Process paper
        if: steps.check.outputs.should_process == 'true'
        id: process
        env:
          CORRECTIONS: ${{ steps.check.outputs.corrections }}
          CATEGORY: ${{ steps.parse.outputs.category }}
        run: |
          # Parse corrections from environment variable (avoids shell quoting issues)
          TITLE=$(echo "$CORRECTIONS" | python3 -c "import sys,json; c=json.loads(sys.stdin.read()); print(c.get('title',''))" 2>/dev/null || echo "")
          AUTHORS=$(echo "$CORRECTIONS" | python3 -c "import sys,json; c=json.loads(sys.stdin.read()); print(c.get('authors',''))" 2>/dev/null || echo "")
          ABSTRACT=$(echo "$CORRECTIONS" | python3 -c "import sys,json; c=json.loads(sys.stdin.read()); print(c.get('abstract',''))" 2>/dev/null || echo "")
          
          # Build command
          CMD="python scripts/process_paper.py process temp/paper.pdf --category \"$CATEGORY\""
          
          if [ -n "$TITLE" ]; then
            CMD="$CMD --title \"$TITLE\""
          fi
          if [ -n "$AUTHORS" ]; then
            CMD="$CMD --authors \"$AUTHORS\""
          fi
          if [ -n "$ABSTRACT" ]; then
            CMD="$CMD --abstract \"$ABSTRACT\""
          fi
          
          echo "Running: $CMD"
          RESULT=$(eval $CMD)
          
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check if successful
          STATUS=$(echo "$RESULT" | python3 -c "import sys,json; print(json.loads(sys.stdin.read()).get('status',''))")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
      
      - name: Move PDF to papers directory
        if: steps.check.outputs.should_process == 'true' && steps.process.outputs.status == 'success'
        run: |
          RESULT='${{ steps.process.outputs.result }}'
          SLUG=$(echo "$RESULT" | python3 -c "import sys,json; print(json.loads(sys.stdin.read()).get('slug','paper'))")
          CATEGORY=$(echo "$RESULT" | python3 -c "import sys,json; print(json.loads(sys.stdin.read()).get('category','other'))")
          
          mkdir -p "papers/$CATEGORY/$SLUG"
          
          # Copy stamped PDF with slug-based name
          cp temp/paper.pdf "papers/$CATEGORY/$SLUG/${SLUG}.pdf"
      
      - name: Commit and push
        if: steps.check.outputs.should_process == 'true' && steps.process.outputs.status == 'success'
        run: |
          git config user.name "corpXiv Bot"
          git config user.email "bot@corpxiv.org"
          
          git add -A
          git commit -m "Add paper: $(echo '${{ steps.process.outputs.result }}' | python3 -c "import sys,json; print(json.loads(sys.stdin.read()).get('title','New paper')[:50])")"
          git push
      
      - name: Comment success
        if: steps.check.outputs.should_process == 'true' && steps.process.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const result = JSON.parse(`${{ steps.process.outputs.result }}`);
            
            const comment = `## üéâ Paper Published!
            
            Your paper is now live on corpXiv.
            
            **corpXiv ID:** \`${result.corpxiv_id}\`
            
            **Landing Page:** https://corpxiv.github.io/corpXiv/papers/${result.category}/${result.slug}/
            
            **PDF:** https://corpxiv.github.io/corpXiv/papers/${result.category}/${result.slug}/${result.slug}.pdf
            
            **Citation:**
            \`\`\`
            ${result.authors?.join(', ') || 'Unknown'}. "${result.title}". corpXiv:${result.corpxiv_id}, ${result.date}.
            \`\`\`
            
            Thank you for contributing to corpXiv! üôè`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            // Close issue and update labels
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'awaiting-confirmation'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['published']
            });
      
      - name: Comment failure
        if: steps.check.outputs.should_process == 'true' && steps.process.outputs.status == 'error'
        uses: actions/github-script@v7
        with:
          script: |
            const result = JSON.parse(`${{ steps.process.outputs.result }}`);
            
            const errors = result.errors?.map(e => `- ‚ùå ${e}`).join('\n') || 'Unknown error';
            const warnings = result.warnings?.map(w => `- ‚ö†Ô∏è ${w}`).join('\n') || '';
            
            const comment = `## ‚ö†Ô∏è Validation Failed
            
            Your paper could not be processed:
            
            ${errors}
            ${warnings ? '\n**Warnings:**\n' + warnings : ''}
            
            Please fix these issues and submit again, or reply with corrections.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
